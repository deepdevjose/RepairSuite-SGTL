// Schema optimizado para SQL Server 2022
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// =====================================================
// MÓDULO DE USUARIOS Y AUTENTICACIÓN
// =====================================================

model Usuario {
  id        String   @id @default(uuid())
  nombre    String
  email     String   @unique
  password  String   // Hasheado con bcrypt
  rol       String   // Administrador, Tecnico, Recepcion
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  ordenesAsignadas      OrdenServicio[]        @relation("TecnicoAsignado")
  movimientosInventario MovimientoInventario[]
  notificaciones        Notificacion[]
  ventasRegistradas     Venta[]                @relation("VentasRegistradas")
  pagosVentaRegistrados PagoVenta[]            @relation("PagosVentaRegistrados")
  dispositivosTecnologicos DispositivoTecnologico[]
  historialesHuella     HistorialHuella[]
  
  @@map("usuarios")
  @@index([email])
  @@index([rol, activo])
}

// =====================================================
// MÓDULO DE CLIENTES
// =====================================================

model Cliente {
  id        String   @id @default(uuid())
  
  // Nombre completo dividido
  nombre1          String   // Primer nombre (requerido)
  nombre2          String?  // Segundo nombre (opcional)
  apellidoPaterno  String   // Apellido paterno (requerido)
  apellidoMaterno  String?  // Apellido materno (opcional)
  
  // Datos de contacto
  telefono  String
  email     String?
  
  // Dirección completa
  calle      String?
  numero     String?
  colonia    String?
  municipio  String?
  estado     String?
  pais       String   @default("México")
  
  // Datos adicionales
  sexo          String?  // M, F, O
  edad          Int?
  rfc           String?
  tipoCliente   String?  // publico_general, empresa, recurrente
  
  // Notas y estado
  notas         String?  @db.Text
  activo        Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  equipos Equipo[]
  ordenes OrdenServicio[]
  ventas  Venta[]
  
  @@map("clientes")
  @@index([telefono])
  @@index([nombre1, apellidoPaterno])
  @@index([activo])
  @@index([email])
}

// =====================================================
// MÓDULO DE EQUIPOS
// =====================================================

model Equipo {
  id          String   @id @default(uuid())
  clienteId   String
  tipo        String   // Laptop, PC, Tablet, etc.
  marca       String
  modelo      String
  numeroSerie String?
  notas       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  ordenes OrdenServicio[]
  
  @@map("equipos")
  @@index([clienteId])
  @@index([numeroSerie])
}

// =====================================================
// MÓDULO DE ÓRDENES DE SERVICIO
// =====================================================

model OrdenServicio {
  id                  String   @id @default(uuid())
  folio               String   @unique
  clienteId           String
  equipoId            String
  tecnicoId           String?
  
  // Información inicial
  problemaReportado   String   @db.Text
  estado              String   // Recibida, Esperando diagnóstico, En diagnóstico, Diagnóstico terminado, Esperando aprobación, En reparación, Reparación terminada, Lista para entrega, Pagado y entregado, Cancelada
  prioridad           String   @default("Normal") // Baja, Normal, Alta, Urgente
  
  // Diagnóstico (llenado por técnico)
  diagnostico         String?  @db.Text
  cotizacion          Decimal? @db.Decimal(10, 2)
  tiempoEstimado      Int?     // En horas
  
  // Reparación
  reparacionNotas     String?  @db.Text
  fechaInicio         DateTime?
  fechaCompletado     DateTime?
  
  // Pagos
  anticipo            Decimal? @db.Decimal(10, 2)
  montoTotal          Decimal? @db.Decimal(10, 2)
  saldoPendiente      Decimal? @db.Decimal(10, 2)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relaciones
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  equipo    Equipo   @relation(fields: [equipoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tecnico   Usuario? @relation("TecnicoAsignado", fields: [tecnicoId], references: [id])
  materiales MaterialOrden[]
  garantia  Garantia?
  pagos     Pago[]
  ventas    Venta[]
  
  @@map("ordenes_servicio")
  @@index([folio])
  @@index([estado, createdAt])
  @@index([tecnicoId, estado])
  @@index([clienteId])
}

// =====================================================
// MÓDULO DE INVENTARIO
// =====================================================

model Producto {
  id                String   @id @default(uuid())
  sku               String   @unique
  nombre            String
  descripcion       String?  @db.Text
  categoria         String   // ComponentesHardware, Pantallas, Teclados, Baterias, Cargadores, Memorias, Discos, Cables, Accesorios, Consumibles, Servicios
  tipo              String   // Producto, Servicio
  
  // Información adicional
  marca             String?
  modelo            String?
  compatibilidad    String?  @db.Text
  especificaciones  String?  @db.Text
  ubicacion         String?  // Ubicación física en almacén
  
  // Precios y stock
  precioCompra      Decimal  @db.Decimal(10, 2)
  precioVenta       Decimal  @db.Decimal(10, 2)
  stockActual       Int      @default(0)
  stockReservado    Int      @default(0)
  stockMinimo       Int      @default(5)
  
  // Proveedor
  proveedorId       String?
  
  activo            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  proveedor         Proveedor? @relation(fields: [proveedorId], references: [id])
  movimientos       MovimientoInventario[]
  materialesOrden   MaterialOrden[]
  itemsVenta        ItemVenta[]
  
  @@map("productos")
  @@index([sku])
  @@index([categoria, activo])
  @@index([stockActual])
}

model MovimientoInventario {
  id          String   @id @default(uuid())
  productoId  String
  tipo        String   // Entrada, Salida, Ajuste, Devolucion
  cantidad    Int
  motivo      String
  usuarioId   String
  ordenId     String?
  createdAt   DateTime @default(now())

  // Relaciones
  producto    Producto @relation(fields: [productoId], references: [id])
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  
  @@map("movimientos_inventario")
  @@index([productoId, createdAt])
  @@index([tipo, createdAt])
}

model MaterialOrden {
  id             String   @id @default(uuid())
  ordenId        String
  productoId     String
  cantidad       Int
  precioUnitario Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())

  // Relaciones
  orden    OrdenServicio @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  producto Producto      @relation(fields: [productoId], references: [id])
  
  @@map("materiales_orden")
  @@index([ordenId])
  @@index([productoId])
}

// =====================================================
// MÓDULO DE PROVEEDORES
// =====================================================

model Proveedor {
  id          String   @id @default(uuid())
  nombre      String
  contacto    String?
  telefono    String
  email       String?
  direccion   String?
  notas       String?  @db.Text
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  productos   Producto[]
  
  @@map("proveedores")
  @@index([nombre])
  @@index([activo])
}

// =====================================================
// MÓDULO DE VENTAS
// =====================================================

model Venta {
  id                 String    @id @default(uuid())
  folio              String    @unique
  clienteId          String
  usuarioId          String    // Usuario que registró la venta
  ordenServicioId    String?   // Relación con orden de servicio (opcional para ventas directas)
  
  // Montos
  subtotal           Decimal   @db.Decimal(10, 2)
  descuento          Decimal   @default(0) @db.Decimal(10, 2)
  impuestos          Decimal   @db.Decimal(10, 2)
  total              Decimal   @db.Decimal(10, 2)
  
  // Pagos
  montoPagado        Decimal   @default(0) @db.Decimal(10, 2)
  saldoPendiente     Decimal   @db.Decimal(10, 2)
  metodoPago         String    // Efectivo, Tarjeta, Transferencia, MercadoPago, Depósito, Mixto
  estadoPago         String    @default("Pendiente") // Pagado, Parcial, Pendiente, Vencido
  
  // Fechas
  fechaVencimiento   DateTime?
  fechaCompletado    DateTime?
  
  estado             String    @default("Completada") // Completada, Cancelada
  notas              String?   @db.Text
  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relaciones
  cliente            Cliente         @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuario            Usuario         @relation("VentasRegistradas", fields: [usuarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ordenServicio      OrdenServicio?  @relation(fields: [ordenServicioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  items              ItemVenta[]
  pagos              PagoVenta[]
  
  @@map("ventas")
  @@index([folio])
  @@index([clienteId, createdAt])
  @@index([estado])
  @@index([estadoPago])
  @@index([ordenServicioId])
}

model ItemVenta {
  id              String   @id @default(uuid())
  ventaId         String
  productoId      String
  cantidad        Int
  precioUnitario  Decimal  @db.Decimal(10, 2)
  costoUnitario   Decimal  @default(0) @db.Decimal(10, 2) // Para cálculo de utilidad
  subtotal        Decimal  @db.Decimal(10, 2)
  tipo            String   @default("Producto") // Producto, Servicio
  createdAt       DateTime @default(now())

  // Relaciones
  venta    Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])
  
  @@map("items_venta")
  @@index([ventaId])
  @@index([productoId])
}

model PagoVenta {
  id              String   @id @default(uuid())
  ventaId         String
  monto           Decimal  @db.Decimal(10, 2)
  metodoPago      String   // Efectivo, Tarjeta, Transferencia, MercadoPago, Depósito
  referencia      String?  // Número de referencia/autorización
  comprobante     String?  // URL del comprobante
  notas           String?  @db.Text
  usuarioId       String   // Usuario que registró el pago
  createdAt       DateTime @default(now())

  // Relaciones
  venta    Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  usuario  Usuario  @relation("PagosVentaRegistrados", fields: [usuarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("pagos_venta")
  @@index([ventaId, createdAt])
  @@index([metodoPago])
}


// =====================================================
// MÓDULO DE PAGOS
// =====================================================

model Pago {
  id                String   @id @default(uuid())
  ordenServicioId   String
  monto             Decimal  @db.Decimal(10, 2)
  metodoPago        String   // Efectivo, Tarjeta, Transferencia, Cheque
  referencia        String?  // No. de transacción o referencia
  notas             String?  @db.Text
  fechaPago         DateTime @default(now())
  createdAt         DateTime @default(now())
  
  // Relaciones
  ordenServicio     OrdenServicio @relation(fields: [ordenServicioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("pagos")
  @@index([ordenServicioId, fechaPago])
}

// =====================================================
// MÓDULO DE GARANTÍAS
// =====================================================

model Garantia {
  id                String   @id @default(uuid())
  ordenId           String   @unique
  diasGarantia      Int
  fechaInicio       DateTime
  fechaVencimiento  DateTime
  descripcion       String   @db.Text
  activa            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  orden OrdenServicio @relation(fields: [ordenId], references: [id])
  
  @@map("garantias")
  @@index([ordenId])
  @@index([fechaVencimiento, activa])
}

// =====================================================
// MÓDULO DE NOTIFICACIONES
// =====================================================

model Notificacion {
  id          String   @id @default(uuid())
  usuarioId   String?  // Si es null, es para todos los usuarios
  titulo      String
  descripcion String   @db.Text
  tipo        String   // orden, inventario, garantia, sistema, general
  ordenId     String?  // Para notificaciones relacionadas con órdenes
  leida       Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  usuario     Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("notificaciones")
  @@index([usuarioId, leida, createdAt])
  @@index([tipo, createdAt])
}

// =====================================================
// MÓDULO DE CONFIGURACIÓN
// =====================================================

model Configuracion {
  id     String @id @default(uuid())
  clave  String @unique
  valor  String @db.Text
  tipo   String // string, number, boolean, json
  
  @@map("configuracion")
}

// =====================================================
// MÓDULO JLABECO - HUELLA DE CARBONO
// =====================================================

model DispositivoTecnologico {
  id                    String   @id @default(uuid())
  tipo                  String   // Router, Switch, Servidor, PC, Laptop, Monitor, Impresora, etc.
  marca                 String
  modelo                String
  serie                 String?
  
  // Consumo energético
  consumoWatts          Decimal  @db.Decimal(10, 2) // Consumo en watts
  horasUsoMensual       Decimal  @db.Decimal(10, 2) @default(720) // ~30 días * 24 horas
  consumoKwhMensual     Decimal  @db.Decimal(10, 2) // Calculado: (consumoWatts * horasUsoMensual) / 1000
  
  // Huella de carbono operativa (uso)
  factorEmisionKwhCO2e  Decimal  @db.Decimal(10, 6) @default(0.527) // kg CO2e por kWh (promedio México)
  huellaOperativaMensual Decimal @db.Decimal(10, 2) // kg CO2e/mes = consumoKwhMensual * factorEmisionKwhCO2e
  
  // Huella de carbono de materiales (fabricación)
  huellaMaterialesKgCO2e Decimal @db.Decimal(10, 2) // kg CO2e total de fabricación
  vidaUtilAnios         Int      @default(5) // Vida útil estimada en años
  huellaMaterialesMensual Decimal @db.Decimal(10, 2) // Amortización mensual: huellaMateriales / (vidaUtilAnios * 12)
  
  // Huella total
  huellaTotalMensual    Decimal  @db.Decimal(10, 2) // huellaOperativaMensual + huellaMaterialesMensual
  
  // Datos adicionales
  ubicacion             String?  // Área física donde está el dispositivo
  responsable           String?  // Persona a cargo
  fechaAdquisicion      DateTime?
  fechaBaja             DateTime?
  
  activo                Boolean  @default(true)
  notas                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  usuarioId             String
  
  // Relaciones
  usuario               Usuario  @relation(fields: [usuarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("dispositivos_tecnologicos")
  @@index([tipo, activo])
  @@index([fechaAdquisicion])
  @@index([activo, createdAt])
}

model HistorialHuella {
  id                    String   @id @default(uuid())
  periodo               DateTime // Mes de referencia (primer día del mes)
  
  // KPIs agregados del periodo
  totalConsumoKwh       Decimal  @db.Decimal(12, 2)
  totalHuellaOperativa  Decimal  @db.Decimal(12, 2) // kg CO2e
  totalHuellaMateriales Decimal  @db.Decimal(12, 2) // kg CO2e
  totalHuella           Decimal  @db.Decimal(12, 2) // kg CO2e
  
  dispositivosActivos   Int      // Cantidad de dispositivos activos en el periodo
  
  // Datos calculados
  promedioConsumoDispositivo Decimal @db.Decimal(10, 2) // kWh promedio por dispositivo
  costoElectrico        Decimal? @db.Decimal(10, 2) // Costo estimado (opcional)
  tarifaKwh             Decimal? @db.Decimal(10, 4) // Tarifa por kWh usada
  
  notas                 String?  @db.Text
  createdAt             DateTime @default(now())
  usuarioId             String
  
  // Relaciones
  usuario               Usuario  @relation(fields: [usuarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("historial_huella")
  @@index([periodo])
  @@unique([periodo])
}
