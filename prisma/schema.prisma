generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                       String                   @id @default(uuid())
  nombre                   String
  email                    String                   @unique
  password                 String
  rol                      String
  activo                   Boolean                  @default(true)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  empleadoId               String?
  dispositivosTecnologicos DispositivoTecnologico[]
  historialesHuella        HistorialHuella[]
  movimientosInventario    MovimientoInventario[]
  notificaciones           Notificacion[]
  pagosVentaRegistrados    PagoVenta[]              @relation("PagosVentaRegistrados")
  solicitudesInventario    SolicitudInventario[]
  ticketsRetiro            TicketRetiro[]
  empleado                 Empleado?                @relation(fields: [empleadoId], references: [id])
  ventasRegistradas        Venta[]                  @relation("VentasRegistradas")

  @@index([email])
  @@index([rol, activo])
  @@map("usuarios")
}

model Empleado {
  id               String    @id @default(uuid())
  nombre           String
  apellidos        String
  nombreCompleto   String
  rolOperativo     String
  sucursalAsignada String    @default("Sede A")
  telefono         String?
  correoInterno    String?   @unique
  estado           String    @default("Activo")
  horarioTrabajo   String?
  especialidades   String?   @db.Text
  avatar           String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  usuarios         Usuario[]

  @@index([correoInterno])
  @@index([rolOperativo])
  @@index([estado])
  @@map("empleados")
}

model Cliente {
  id              String   @id @default(uuid())
  telefono        String
  email           String?
  notas           String?  @db.Text
  activo          Boolean
  createdAt       DateTime
  updatedAt       DateTime @updatedAt
  nombre1         String
  nombre2         String?
  apellidoPaterno String
  apellidoMaterno String?
  calle           String?
  numero          String?
  colonia         String?
  municipio       String?
  estado          String?
  pais            String
  sexo            String?
  edad            Int?
  rfc             String?
  tipoCliente     String?
  equipos         Equipo[]
  ventas          Venta[]

  @@map("clientes")
}

model Equipo {
  id                  String   @id @default(uuid())
  clienteId           String
  tipo                String
  marca               String
  modelo              String
  numeroSerie         String?
  notas               String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  color               String?
  fechaIngreso        DateTime @default(now(), map: "DF__equipos__fechaIn__6166761E")
  estadoFisico        String?  @db.Text
  accesoriosRecibidos String?  @db.Text
  enciende            String?
  tieneContrasena     Boolean  @default(false)
  contrasena          String?
  cliente             Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([numeroSerie])
  @@map("equipos")
}

model OrdenServicio {
  id                String          @id @default(uuid())
  folio             String          @unique
  clienteId         String
  equipoId          String
  tecnicoId         String?
  problemaReportado String          @db.Text
  estado            String
  prioridad         String
  diagnostico       String?         @db.Text
  cotizacion        Decimal?        @db.Decimal(10, 2)
  tiempoEstimado    Int?
  reparacionNotas   String?         @db.Text
  fechaInicio       DateTime?
  fechaCompletado   DateTime?
  anticipo          Decimal?        @db.Decimal(10, 2)
  montoTotal        Decimal?        @db.Decimal(10, 2)
  saldoPendiente    Decimal?        @db.Decimal(10, 2)
  createdAt         DateTime
  updatedAt         DateTime        @updatedAt
  anticipoRequerido Decimal?        @db.Decimal(10, 2)
  tipoServicio      String?
  fechaEstimadaFin  DateTime?
  garantia          Garantia?
  materiales        MaterialOrden[]
  pagos             Pago[]
  ventas            Venta[]

  @@map("ordenes_servicio")
}

model Producto {
  id                 String                 @id @default(uuid())
  sku                String                 @unique
  nombre             String
  descripcion        String?                @db.Text
  categoria          String
  tipo               String
  marca              String?
  modelo             String?
  compatibilidad     String?                @db.Text
  especificaciones   String?                @db.Text
  ubicacion          String?
  precioCompra       Decimal                @db.Decimal(10, 2)
  precioVenta        Decimal                @db.Decimal(10, 2)
  stockActual        Int                    @default(0)
  stockReservado     Int                    @default(0)
  stockMinimo        Int                    @default(5)
  proveedorId        String?
  activo             Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  garantiaMeses      Int                    @default(0)
  itemsVenta         ItemVenta[]
  materialesOrden    MaterialOrden[]
  movimientos        MovimientoInventario[]
  proveedor          Proveedor?             @relation(fields: [proveedorId], references: [id])
  ticketsRetiroItems TicketRetiroItem[]

  @@index([sku])
  @@index([categoria, activo])
  @@index([stockActual])
  @@map("productos")
}

model MovimientoInventario {
  id         String   @id @default(uuid())
  productoId String
  tipo       String
  cantidad   Int
  motivo     String
  usuarioId  String
  ordenId    String?
  createdAt  DateTime @default(now())
  producto   Producto @relation(fields: [productoId], references: [id])
  usuario    Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([productoId, createdAt])
  @@index([tipo, createdAt])
  @@map("movimientos_inventario")
}

model SolicitudInventario {
  id          String   @id @default(uuid())
  tipo        String
  marca       String?
  modelo      String?
  descripcion String   @db.Text
  estado      String   @default("Pendiente")
  usuarioId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId, estado])
  @@index([createdAt])
  @@map("solicitudes_inventario")
}

model TicketRetiro {
  id              String             @id @default(uuid())
  codigo          String             @unique
  usuarioId       String
  estado          String             @default("Pendiente")
  fechaExpiracion DateTime
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  items           TicketRetiroItem[]
  usuario         Usuario            @relation(fields: [usuarioId], references: [id])

  @@index([codigo])
  @@index([usuarioId, estado])
  @@map("tickets_retiro")
}

model TicketRetiroItem {
  id         String       @id @default(uuid())
  ticketId   String
  productoId String
  cantidad   Int
  producto   Producto     @relation(fields: [productoId], references: [id])
  ticket     TicketRetiro @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([productoId])
  @@map("ticket_retiro_items")
}

model MaterialOrden {
  id             String        @id @default(uuid())
  ordenId        String
  productoId     String
  cantidad       Int
  precioUnitario Decimal       @db.Decimal(10, 2)
  createdAt      DateTime      @default(now())
  orden          OrdenServicio @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  producto       Producto      @relation(fields: [productoId], references: [id])

  @@index([ordenId])
  @@index([productoId])
  @@map("materiales_orden")
}

model Proveedor {
  id        String     @id @default(uuid())
  nombre    String
  contacto  String?
  telefono  String
  email     String?
  direccion String?
  notas     String?    @db.Text
  activo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  productos Producto[]

  @@index([nombre])
  @@index([activo])
  @@map("proveedores")
}

model Venta {
  id               String         @id @default(uuid())
  folio            String         @unique
  clienteId        String
  usuarioId        String
  ordenServicioId  String?
  subtotal         Decimal        @db.Decimal(10, 2)
  descuento        Decimal        @default(0) @db.Decimal(10, 2)
  impuestos        Decimal        @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  montoPagado      Decimal        @default(0) @db.Decimal(10, 2)
  saldoPendiente   Decimal        @db.Decimal(10, 2)
  metodoPago       String
  estadoPago       String         @default("Pendiente")
  fechaVencimiento DateTime?
  fechaCompletado  DateTime?
  estado           String         @default("Completada")
  notas            String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  items            ItemVenta[]
  pagos            PagoVenta[]
  cliente          Cliente        @relation(fields: [clienteId], references: [id], onUpdate: NoAction)
  ordenServicio    OrdenServicio? @relation(fields: [ordenServicioId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuario          Usuario        @relation("VentasRegistradas", fields: [usuarioId], references: [id], onUpdate: NoAction)

  @@index([folio])
  @@index([clienteId, createdAt])
  @@index([estado])
  @@index([estadoPago])
  @@index([ordenServicioId])
  @@map("ventas")
}

model ItemVenta {
  id             String   @id @default(uuid())
  ventaId        String
  productoId     String
  cantidad       Int
  precioUnitario Decimal  @db.Decimal(10, 2)
  costoUnitario  Decimal  @default(0) @db.Decimal(10, 2)
  subtotal       Decimal  @db.Decimal(10, 2)
  tipo           String   @default("Producto")
  createdAt      DateTime @default(now())
  producto       Producto @relation(fields: [productoId], references: [id])
  venta          Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  @@index([ventaId])
  @@index([productoId])
  @@map("items_venta")
}

model PagoVenta {
  id          String   @id @default(uuid())
  ventaId     String
  monto       Decimal  @db.Decimal(10, 2)
  metodoPago  String
  referencia  String?
  comprobante String?
  notas       String?  @db.Text
  usuarioId   String
  createdAt   DateTime @default(now())
  usuario     Usuario  @relation("PagosVentaRegistrados", fields: [usuarioId], references: [id], onUpdate: NoAction)
  venta       Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  @@index([ventaId, createdAt])
  @@index([metodoPago])
  @@map("pagos_venta")
}

model Pago {
  id              String        @id @default(uuid())
  ordenServicioId String
  monto           Decimal       @db.Decimal(10, 2)
  metodoPago      String
  referencia      String?
  notas           String?       @db.Text
  fechaPago       DateTime      @default(now())
  createdAt       DateTime      @default(now())
  ordenServicio   OrdenServicio @relation(fields: [ordenServicioId], references: [id], onUpdate: NoAction)

  @@index([ordenServicioId, fechaPago])
  @@map("pagos")
}

model Garantia {
  id               String        @id @default(uuid())
  ordenId          String        @unique
  diasGarantia     Int
  fechaInicio      DateTime
  fechaVencimiento DateTime
  descripcion      String        @db.Text
  activa           Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  orden            OrdenServicio @relation(fields: [ordenId], references: [id])

  @@index([ordenId])
  @@index([fechaVencimiento, activa])
  @@map("garantias")
}

model Notificacion {
  id          String   @id @default(uuid())
  usuarioId   String?
  titulo      String
  descripcion String   @db.Text
  tipo        String
  ordenId     String?
  leida       Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usuario     Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, leida, createdAt])
  @@index([tipo, createdAt])
  @@map("notificaciones")
}

model Configuracion {
  id    String @id @default(uuid())
  clave String @unique
  valor String @db.Text
  tipo  String

  @@map("configuracion")
}

model DispositivoTecnologico {
  id                      String    @id @default(uuid())
  tipo                    String
  marca                   String
  modelo                  String
  serie                   String?
  consumoWatts            Decimal   @db.Decimal(10, 2)
  horasUsoMensual         Decimal   @default(720) @db.Decimal(10, 2)
  consumoKwhMensual       Decimal   @db.Decimal(10, 2)
  factorEmisionKwhCO2e    Decimal   @default(0.527) @db.Decimal(10, 6)
  huellaOperativaMensual  Decimal   @db.Decimal(10, 2)
  huellaMaterialesKgCO2e  Decimal   @db.Decimal(10, 2)
  vidaUtilAnios           Int       @default(5)
  huellaMaterialesMensual Decimal   @db.Decimal(10, 2)
  huellaTotalMensual      Decimal   @db.Decimal(10, 2)
  ubicacion               String?
  responsable             String?
  fechaAdquisicion        DateTime?
  fechaBaja               DateTime?
  activo                  Boolean   @default(true)
  notas                   String?   @db.Text
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  usuarioId               String
  usuario                 Usuario   @relation(fields: [usuarioId], references: [id], onUpdate: NoAction)

  @@index([tipo, activo])
  @@index([fechaAdquisicion])
  @@index([activo, createdAt])
  @@map("dispositivos_tecnologicos")
}

model HistorialHuella {
  id                         String   @id @default(uuid())
  periodo                    DateTime @unique
  totalConsumoKwh            Decimal  @db.Decimal(12, 2)
  totalHuellaOperativa       Decimal  @db.Decimal(12, 2)
  totalHuellaMateriales      Decimal  @db.Decimal(12, 2)
  totalHuella                Decimal  @db.Decimal(12, 2)
  dispositivosActivos        Int
  promedioConsumoDispositivo Decimal  @db.Decimal(10, 2)
  costoElectrico             Decimal? @db.Decimal(10, 2)
  tarifaKwh                  Decimal? @db.Decimal(10, 4)
  notas                      String?  @db.Text
  createdAt                  DateTime @default(now())
  usuarioId                  String
  usuario                    Usuario  @relation(fields: [usuarioId], references: [id], onUpdate: NoAction)

  @@index([periodo])
  @@map("historial_huella")
}
